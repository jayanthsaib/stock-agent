<!DOCTYPE html>
<html lang="en" data-bs-theme="dark" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/layout :: head('Performance')}"></head>
<body>

<div th:replace="~{fragments/layout :: sidebar('performance')}"></div>

<div id="main">
    <!-- Top bar -->
    <div id="topbar">
        <div class="page-title"><i class="fa-solid fa-chart-line me-2" style="color:#58a6ff;"></i>Performance</div>
        <span class="text-muted small" id="clock"></span>
        <button class="btn btn-sm btn-outline-secondary ms-2" onclick="location.reload()" title="Refresh">
            <i class="fa-solid fa-rotate-right"></i>
        </button>
    </div>

    <div class="content-area">

        <!-- Key metrics -->
        <div class="row g-3 mb-4">
            <div class="col-md-2 col-sm-4 col-6">
                <div class="stat-card h-100">
                    <div class="label">Total Trades</div>
                    <div class="value" th:text="${totalTrades}">0</div>
                    <div class="sub">Closed</div>
                </div>
            </div>
            <div class="col-md-2 col-sm-4 col-6">
                <div class="stat-card h-100">
                    <div class="label">Win Rate</div>
                    <div class="value" style="color:#3fb950;" th:text="${winRate} + '%'">0%</div>
                    <div class="sub" th:text="${wins} + 'W / ' + ${losses} + 'L'">0W / 0L</div>
                </div>
            </div>
            <div class="col-md-2 col-sm-4 col-6">
                <div class="stat-card h-100">
                    <div class="label">Total P&amp;L</div>
                    <div class="value"
                         th:classappend="${#strings.startsWith(totalPnl,'-') ? 'pnl-negative' : 'pnl-positive'}"
                         th:text="'₹' + ${totalPnl}">₹0</div>
                    <div class="sub">Realised</div>
                </div>
            </div>
            <div class="col-md-2 col-sm-4 col-6">
                <div class="stat-card h-100">
                    <div class="label">Avg P&amp;L / Trade</div>
                    <div class="value" style="font-size:20px;"
                         th:classappend="${#strings.startsWith(avgPnl,'-') ? 'pnl-negative' : 'pnl-positive'}"
                         th:text="'₹' + ${avgPnl}">₹0</div>
                    <div class="sub">Per closed trade</div>
                </div>
            </div>
            <div class="col-md-4 col-sm-8 col-12">
                <div class="stat-card h-100">
                    <div class="label">Confidence Calibration</div>
                    <pre style="font-size:11px;color:#8b949e;margin:0;white-space:pre-wrap;"
                         th:text="${calibration}">Insufficient data</pre>
                </div>
            </div>
        </div>

        <!-- Cumulative P&L chart -->
        <div class="table-card mb-4" th:if="${totalTrades > 0}">
            <div class="card-header-bar">
                <span><i class="fa-solid fa-chart-area me-2" style="color:#58a6ff;"></i>Cumulative P&amp;L</span>
            </div>
            <div style="padding:20px;">
                <canvas id="pnlChart" height="80"></canvas>
            </div>
        </div>

        <!-- Sector analysis -->
        <div class="row g-3 mb-4">
            <div class="col-md-6">
                <div class="stat-card h-100">
                    <div class="label mb-2">Sector Analysis</div>
                    <pre style="font-size:12px;color:#c9d1d9;margin:0;white-space:pre-wrap;"
                         th:text="${sectorAnalysis}">No sector data</pre>
                </div>
            </div>
            <div class="col-md-6">
                <!-- Win/Loss distribution -->
                <div class="stat-card h-100">
                    <div class="label mb-3">Win / Loss Split</div>
                    <div th:if="${totalTrades == 0}" class="text-muted" style="font-size:13px;">
                        No closed trades yet.
                    </div>
                    <div th:if="${totalTrades > 0}">
                        <div class="d-flex justify-content-between mb-1" style="font-size:12px;">
                            <span style="color:#3fb950;"><i class="fa-solid fa-circle-check me-1"></i>Wins: <th:block th:text="${wins}">0</th:block></span>
                            <span style="color:#f85149;"><i class="fa-solid fa-circle-xmark me-1"></i>Losses: <th:block th:text="${losses}">0</th:block></span>
                        </div>
                        <div style="height:12px;border-radius:6px;overflow:hidden;background:#21262d;">
                            <div style="height:100%;background:linear-gradient(90deg,#238636,#3fb950);border-radius:6px;"
                                 th:style="'width:' + ${winRate} + '%'"></div>
                        </div>
                        <div class="text-muted mt-2" style="font-size:11px;" th:text="${winRate} + '% win rate'"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Closed trades table -->
        <div class="table-card">
            <div class="card-header-bar">
                <span><i class="fa-solid fa-list-check me-2" style="color:#58a6ff;"></i>Closed Trades</span>
                <span class="text-muted small" th:text="${closedTrades.size()} + ' trades'">0 trades</span>
            </div>
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Symbol</th>
                            <th>Signal</th>
                            <th>Entry</th>
                            <th>Exit</th>
                            <th>P&amp;L (₹)</th>
                            <th>P&amp;L (%)</th>
                            <th>Outcome</th>
                            <th>Exit Reason</th>
                            <th>Closed</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:if="${#lists.isEmpty(closedTrades)}">
                            <td colspan="9" class="text-center py-5" style="color:#8b949e;">
                                <i class="fa-solid fa-chart-simple fa-2x mb-3 d-block"></i>
                                No closed trades yet.
                            </td>
                        </tr>
                        <tr th:each="t : ${closedTrades}">
                            <td>
                                <strong th:text="${t.symbol}">RELIANCE</strong>
                                <span class="d-block text-muted" style="font-size:11px;" th:text="${t.exchange}">NSE</span>
                            </td>
                            <td>
                                <span class="badge rounded-pill"
                                      th:classappend="'badge-' + ${#strings.toLowerCase(t.signalType)}"
                                      th:text="${t.signalType}">BUY</span>
                            </td>
                            <td th:text="'₹' + ${#numbers.formatDecimal(t.entryPrice,1,2)}">₹0</td>
                            <td th:text="${t.exitPrice != null ? '₹' + #numbers.formatDecimal(t.exitPrice,1,2) : '—'}">—</td>
                            <td>
                                <span th:if="${t.realisedPnlInr != null}"
                                      th:classappend="${t.realisedPnlInr >= 0 ? 'pnl-positive' : 'pnl-negative'}"
                                      th:text="(${t.realisedPnlInr >= 0 ? '+' : ''}) + '₹' + ${#numbers.formatDecimal(t.realisedPnlInr,1,0)}">₹0</span>
                                <span th:if="${t.realisedPnlInr == null}" class="text-muted">—</span>
                            </td>
                            <td>
                                <span th:if="${t.realisedPnlPct != null}"
                                      th:classappend="${t.realisedPnlPct >= 0 ? 'pnl-positive' : 'pnl-negative'}"
                                      th:text="(${t.realisedPnlPct >= 0 ? '+' : ''}) + ${#numbers.formatDecimal(t.realisedPnlPct,1,2)} + '%'">0%</span>
                                <span th:if="${t.realisedPnlPct == null}" class="text-muted">—</span>
                            </td>
                            <td>
                                <span th:if="${t.targetHit}"
                                      class="badge rounded-pill badge-executed">Target Hit</span>
                                <span th:if="${!t.targetHit}"
                                      class="badge rounded-pill badge-rejected">Stop Loss</span>
                            </td>
                            <td class="text-muted" style="font-size:12px;" th:text="${t.exitReason ?: '—'}">—</td>
                            <td class="text-muted"
                                th:text="${t.closedAt != null ? #temporals.format(t.closedAt, 'dd MMM HH:mm') : '—'}">—</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div><!-- /content-area -->
</div><!-- /main -->

<div th:replace="~{fragments/layout :: scripts}"></div>
<script th:inline="javascript">
    function tick() {
        const now = new Date();
        document.getElementById('clock').textContent =
            now.toLocaleTimeString('en-IN', {hour:'2-digit', minute:'2-digit', second:'2-digit'});
    }
    tick(); setInterval(tick, 1000);
    setTimeout(() => location.reload(), 60000);

    // Cumulative P&L chart
    const labels = /*[[${chartLabels}]]*/ [];
    const data   = /*[[${chartData}]]*/ [];
    if (labels.length > 0) {
        const ctx = document.getElementById('pnlChart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Cumulative P&L (₹)',
                    data: data,
                    borderColor: '#3fb950',
                    backgroundColor: 'rgba(63,185,80,0.08)',
                    pointBackgroundColor: '#3fb950',
                    pointRadius: 3,
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { labels: { color: '#c9d1d9' } }
                },
                scales: {
                    x: { ticks: { color: '#8b949e' }, grid: { color: '#30363d' } },
                    y: {
                        ticks: {
                            color: '#8b949e',
                            callback: v => '₹' + v.toLocaleString('en-IN')
                        },
                        grid: { color: '#30363d' }
                    }
                }
            }
        });
    }
</script>
</body>
</html>
